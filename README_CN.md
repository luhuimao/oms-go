# Atlas OMS – 生产级订单管理系统

[English](README.md) | 简体中文

## 概述

**Atlas OMS** 是一个高性能、生产就绪的订单管理系统（OMS），专为中心化衍生品交易所和专业交易平台设计。借鉴了 **Binance**、**OKX** 和 **Bybit** 的内部架构，Atlas OMS 提供了核心基础设施，以模块化、可扩展的方式处理订单生命周期、风险管理、仓位跟踪和强制平仓。

这**不是一个演示项目**；它的设计考虑了生产环境的可靠性和可扩展性。

---

## 核心特性

### 订单管理

* 完整的订单生命周期（NEW、PARTIALLY_FILLED、FILLED、CANCELED）
* 限价单和市价单
* 幂等的订单处理
* 通过事件与撮合引擎集成

### 仓位与保证金引擎

* 单向持仓模式
* 逐仓保证金支持
* 用户级别可配置杠杆
* 实时盈亏计算和权益追踪

### 强制平仓引擎

* 基于标记价格的强制平仓检查
* 维持保证金强制执行
* IOC 强制平仓订单，实现无缝市场执行
* 保险基金和自动减仓（ADL）挂钩

### 风险管理

* 保证金和杠杆验证
* 维持保证金监控
* 动态风险限制（计划在未来版本中实现）

### 快照与重放 (Snapshot & Replay)

* **事件溯源 (Event Sourcing)**：所有状态变更均记录为不可变的 append-only 事件日志。
* **定期快照**：自动定时创建系统状态快照，加速启动恢复。
* **崩溃恢复**：系统重启时自动加载最新快照并重放后续事件，确保数据零丢失。
* **确定性重放**：可随时通过重放事件日志重建任意时刻的历史状态，便于审计和调试。

### 接口层 (Transport Layer)

* **gRPC API**：高性能内部通信接口，支持订单提交 (`CreateOrder`) 和仓位查询 (`GetPosition`)。
* **Protobuf 契约**：使用 Protocol Buffers 定义严谨的 API 接口 (`api/proto/oms.proto`)。

### 系统设计

* 事件驱动架构
* 内存优先，可选持久化后端
* 确定性和可重放的状态转换
* 基于哈希的工作器分发，确保单订单串行化

---

## IOC 强制平仓 → 撮合引擎闭环

Atlas OMS 实现了**生产级强制平仓流程**：

1. **强制平仓触发**：当仓位的维持保证金被突破时。
2. **仓位冻结**：阻止用户进一步操作。
3. **创建 IOC 强制平仓订单**：生成带有立即成交或取消（IOC）时效的系统市价单。
4. **发送至撮合引擎**：撮合引擎根据订单簿执行。
5. **成交事件回流**：成交信息返回 OMS 以更新仓位、保证金和已实现盈亏。
6. **平仓后处理**：如有必要，通过保险基金或 ADL 处理剩余仓位。

这种设计确保了：

* 强一致性
* 市场驱动的价格发现
* 强制平仓事件的可审计性

---

## 架构

```
客户端 / API
     │
     ▼
┌───────────────┐
│   Atlas OMS   │
│───────────────│
│  gRPC Server  │ <--- 新增
│───────────────│
│ 订单服务      │
│ 仓位服务      │
│ 保证金引擎    │
│ 强制平仓      │
│ 风险引擎      │
└───────┬───────┘
        │ 事件 (Kafka / NATS / MQ)
        ▼
  撮合引擎
        │
        ▼
┌───────────────┐
│  持久化层     │
│───────────────│
│ events.log    │ (WAL 日志)
│ snapshots/    │ (状态快照)
└───────────────┘
```

### 设计原则

* 事件驱动和解耦
* 确定性执行
* 水平可扩展性
* 可重放状态，实现容错

---

## 仓库结构

```
oms-project/
├── cmd/oms/                # 服务入口
├── internal/
│   ├── domain/             # 模型和事件定义
│   ├── service/            # 核心业务逻辑（OMS、仓位、强制平仓、风险）
│   ├── engine/             # 顺序执行引擎 / 调度器
│   ├── memory/             # 内存状态存储
│   ├── snapshot/           # 快照、事件溯源与重放
│   └── infra/              # 集成 / 模拟撮合引擎
├── pkg/                    # 工具类（ID 生成器、辅助函数）
├── go.mod
└── README.md
```

---

## 快速开始

### 前置要求

* Go 1.21+
* Linux/macOS

### 运行

#### 1. 启动 gRPC 服务 (默认模式)

```bash
go run ./cmd/oms
```
默认监听端口 `50051`。可以通过 `--port` 参数指定端口：
```bash
go run ./cmd/oms --port 50051
```

#### 2. 运行演示场景 (CLI 模式)

```bash
go run ./cmd/oms --demo
```
这将启动演示模式，处理示例订单提交、成交执行、仓位更新，并演示 IOC 强制平仓。

**注意**：系统会在当前目录下创建 `data/` 文件夹用于存储事件日志和快照。多次运行该命令，你会发现系统状态（订单和仓位）能够从上一次运行中恢复。

#### 3. 验证 (使用测试客户端)

由于 gRPC 工具链的版本依赖问题，你可以使用内置的测试客户端来验证服务连接：

```bash
# 在一个终端启动服务
go run ./cmd/oms

# 在另一个终端运行客户端
go run ./cmd/client_test/main.go
```

---

## 目标用例

* 中心化衍生品交易所
* 自营交易平台
* 机构交易网关
* 量化研究环境
* 交易所模拟平台

---

## 路线图

**短期：** IOC 强制平仓订单生成、风险限制层级、只减仓位。

**中期：** 全仓保证金支持、对冲模式、保险基金集成。

**长期：** ADL 引擎、组合保证金、多资产抵押。

---

## 许可证

Apache 2.0（或可提供商业许可）。

## 联系方式

获取商业许可或集成支持：

> 📧 [luhuimao@gmail.com](mailto:luhuimao@gmail.com) 

---

**Atlas OMS 旨在成为真实世界衍生品交易平台的核心支撑。它提供了适用于生产环境的可扩展、确定性和可审计的基础设施。**
